<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tunnel 3D ‚Äî Bar √† Chat</title>
<meta name="description" content="Cartes qui arrivent au centre et sortent sur le c√¥t√©. Th√®me bar √† chat (latte/rose/menthe), pause lisible + stick doux.">
<style>
  :root{
    /* Palette Bar √† Chat */
    --bg1:#f8f3ec;        /* cr√®me */
    --bg2:#f3e7da;        /* cappuccino clair */
    --ink:#2b2623;        /* mocha texte */
    --muted:#6d625b;      /* latte */
    --primary:#c98552;    /* caramel */
    --accent:#79c9bf;     /* menthe */
    --rose:#f0a9b7;       /* rose poudr√© */
    --panel:#ffffff;      /* carte cr√®me */
    --line:#eadccd;
    --radius:18px;
    --focus:#e08aa0;      /* focus ros√© */
  }

  *{box-sizing:border-box}
  html,body{height:100%; margin:0}
  body{
    color:var(--ink);
    font: clamp(14px, 1.3vw, 16px)/1.6 "Inter", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, sans-serif;
    overflow-x:hidden; -webkit-tap-highlight-color: transparent;
    background:
      radial-gradient(1200px 700px at 80% -10%, rgba(201,133,82,.12), transparent 60%),
      radial-gradient(900px 600px at 10% 30%, rgba(240,169,183,.12), transparent 60%),
      linear-gradient(180deg, var(--bg1), var(--bg2));
  }

  /* motif pattes discret */
  .paws{
    position:fixed; inset:-40px; z-index:0; pointer-events:none; opacity:.08; mix-blend-mode:multiply;
    background:url('data:image/svg+xml;utf8,\
    <svg xmlns="http://www.w3.org/2000/svg" width="220" height="220" viewBox="0 0 220 220">\
      <g fill="%23c8b6a6">\
        <circle cx="40" cy="40" r="10"/><circle cx="65" cy="30" r="8"/><circle cx="25" cy="25" r="8"/><circle cx="50" cy="60" r="8"/>\
        <path d="M85 85c18-12 34 8 20 20s-38 2-20-20z"/>\
      </g>\
    </svg>') repeat;
    background-size:220px 220px;
    animation:paws 14s linear infinite;
  }
  @keyframes paws { to { transform: translate(110px,110px) } }

  /* Viewport fixe & sc√®ne */
  .viewport{
    position:fixed; inset:0; overflow:hidden;
    perspective: clamp(820px, 85vw, 1100px);
    perspective-origin: 50% 50%;
    touch-action:none;
  }
  .scene{ position:absolute; inset:0; transform-style:preserve-3d; will-change: transform }

  /* Header caf√© */
  header{
    position:fixed; inset:0 0 auto 0; z-index:10; display:flex; align-items:center; justify-content:space-between;
    padding: clamp(8px, 2.5vw, 14px) clamp(12px, 3vw, 22px);
    background:linear-gradient(to bottom, rgba(255,255,255,.75), rgba(255,255,255,0));
    border-bottom:1px solid var(--line); backdrop-filter: blur(8px) saturate(1.05);
  }
  .brand{display:flex; gap:10px; align-items:center; font-weight:800; letter-spacing:.4px; font-size: clamp(14px, 2.8vw, 17px)}
  .mug{
    width:18px; height:18px; border-radius:4px 4px 10px 10px; position:relative;
    background:linear-gradient(180deg, var(--primary), #b77448);
    box-shadow:0 6px 14px rgba(201,133,82,.35) inset, 0 1px 0 rgba(255,255,255,.6);
  }
  .mug:after{content:""; position:absolute; right:-6px; top:4px; width:8px; height:8px; border:3px solid #b77448; border-left-color:transparent; border-bottom-color:transparent; border-radius:50%}
  .hud{display:flex; align-items:center; gap:10px; color:var(--muted); font-size:12px}
  .bar{width: clamp(120px, 30vw, 200px); height:6px; border-radius:999px; background:#e9ded1; overflow:hidden; border:1px solid var(--line)}
  .bar>i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--primary),var(--rose))}

  .state{padding:4px 8px; border-radius:999px; border:1px solid var(--line); background:#fff; color:var(--muted)}

  /* Couches & cartes (avec oreilles) */
  .layer{
    position:absolute; top:50%; left:50%;
    transform-style:preserve-3d; will-change: transform, opacity, filter;
    opacity:var(--o,1); filter: blur(var(--blur, 0px)) saturate(1.02);
  }
  .card{
    min-width: min(560px, 92vw);
    padding: clamp(16px, 3.2vw, 22px);
    border-radius: var(--radius);
    background:linear-gradient(180deg, var(--panel), #fffaf6);
    border:1px solid var(--line);
    box-shadow: 0 18px 40px rgba(90,60,30,.12), 0 1px 0 rgba(255,255,255,.8) inset;
    position:relative;
  }
  /* oreilles de chat */
  .card:before, .card:after{
    content:""; position:absolute; top:-12px; width:26px; height:26px; background:var(--panel);
    border:1px solid var(--line); transform: rotate(45deg);
  }
  .card:before{ left:28px; border-bottom:none; border-right:none }
  .card:after{ right:28px; border-bottom:none; border-left:none }

  .card h2{margin:.2rem 0 .45rem; font-size: clamp(18px, 4.5vw, 24px)}
  .card p{color:var(--muted); margin:.2rem 0; font-size: clamp(13px, 3.7vw, 15px)}
  .chip{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px;
        background:linear-gradient(180deg,#fff,#fde9e9); color:#7a3b44; border:1px solid #f1d1d8; margin-right:6px}
  .chip.mint{ background:linear-gradient(180deg,#fff,#e9f7f5); color:#2b605a; border-color:#cfece8 }
  .chip.caramel{ background:linear-gradient(180deg,#fff,#f5e6d8); color:#7b4a2c; border-color:#ecd7c3 }

  .focused .card{
    border-color: var(--focus);
    box-shadow:
      0 24px 56px rgba(224,138,160,.28),
      0 0 0 1px rgba(255,255,255,.6) inset,
      0 0 0 2px rgba(224,138,160,.16);
  }

  /* Contr√¥les */
  .ctrls{
    position:fixed; right:12px; bottom:72px; z-index:12; display:flex; flex-direction:column; gap:10px;
  }
  .ctrls button{
    width:50px; height:50px; border-radius:14px; border:1px solid var(--line); background:#fff; color:var(--ink);
    box-shadow:0 10px 24px rgba(90,60,30,.12);
    font-size:18px; touch-action:none;
  }
  .ctrls button:active{transform:scale(.98)}

  .scrollspace{ height: 1400px } /* compat desktop */
  .hint{
    position:fixed; left:50%; bottom:16px; transform:translateX(-50%); z-index:10;
    color:var(--muted); font-size:12px; opacity:.95; user-select:none;
    backdrop-filter: blur(6px); background:rgba(255,255,255,.7); border:1px solid var(--line);
    padding:8px 10px; border-radius:999px;
  }
</style>
</head>
<body>
<header>
  <div class="brand"><span class="mug" aria-hidden="true"></span> Bar √† Chat ‚Äî D√©mo</div>
  <div class="hud" aria-label="Profondeur">
    <div class="bar" title="Progression"><i id="prog"></i></div>
    <span id="depthVal">Z: 0</span>
    <span class="state" id="state">Mode: libre</span>
  </div>
</header>

<div class="viewport" id="viewport" aria-label="Sc√®ne 3D">
  <div class="scene" id="scene">
    <!-- data-z espac√©s (~800). data-dir = direction de sortie: -1 gauche, 1 droite -->
    <div class="layer" data-z="-3600" data-dir="-1"><div class="card"><span class="chip caramel">Bienvenue</span><h2>Bienvenue au Bar √† Chat</h2><p>Entrez, installez-vous. Les cartes arrivent au centre et repartent sur le c√¥t√©.</p></div></div>
    <div class="layer" data-z="-2800" data-dir="1"><div class="card"><span class="chip">Concept</span><h2>Cam√©ra en profondeur</h2><p>Perspective CSS + <code>translateZ</code>. Pause courte au focus pour lire.</p></div></div>
    <div class="layer" data-z="-2000" data-dir="-1"><div class="card"><span class="chip mint">Douceur</span><h2>Nettet√© & taille</h2><p>Plus c‚Äôest loin, plus c‚Äôest discret. Au centre : net & lisible.</p></div></div>
    <div class="layer" data-z="-1200" data-dir="1"><div class="card"><span class="chip caramel">Rythme</span><h2>Pause + stick</h2><p>La carte reste un peu puis suit le mouvement avant de filer de c√¥t√©.</p></div></div>
    <div class="layer" data-z="-400" data-dir="-1"><div class="card"><span class="chip">Plan 0</span><h2>Point de focus</h2><p>Rep√®re central, oreilles en alerte üêæ</p></div></div>
    <div class="layer" data-z="400" data-dir="1"><div class="card"><span class="chip mint">Suite</span><h2>Sortie lat√©rale</h2><p>Elle glisse proprement vers la droite (ou gauche) hors cadre.</p></div></div>
    <div class="layer" data-z="1200" data-dir="-1"><div class="card"><span class="chip caramel">Contenus</span><h2>Ajoutez vos cartes</h2><p>Dupliquez une <code>.layer</code>, r√©glez <code>data-z</code> & <code>data-dir</code>.</p></div></div>
    <div class="layer" data-z="2000" data-dir="1"><div class="card"><span class="chip">Merci</span><h2>√Ä tr√®s vite</h2><p>On se retrouve pour un cappuccino‚Ä¶ et des c√¢lins de chat üò∫</p></div></div>
  </div>
</div>

<div class="ctrls" aria-label="Contr√¥les">
  <button id="back" aria-label="Reculer">‚óÑ</button>
  <button id="fw" aria-label="Avancer">‚ñ∫</button>
</div>

<div class="scrollspace" aria-hidden="true"></div>
<div class="paws" aria-hidden="true"></div>
<div class="hint">Swipe / Scroll doux ‚Ä¢ Pause au centre ‚Ä¢ Sortie lat√©rale</div>

<script>
/*
  Nouveaut√©s c√¥t√© mouvement :
  - Sortie lat√©rale : apr√®s le focus, la carte se d√©cale en X (gauche/droite, data-dir ¬±1)
    avec une courbe douce. L‚Äôentr√©e reste centr√©e.
  - Palette & UI ‚ÄúBar √† chat‚Äù.
  - On garde ‚Äúpause‚Äù + ‚Äústick‚Äù doux.
*/
(function(){
  const scene = document.getElementById('scene');
  const viewport = document.getElementById('viewport');
  const layers = Array.from(document.querySelectorAll('.layer'));
  const prog = document.getElementById('prog');
  const depthText = document.getElementById('depthVal');
  const stateText = document.getElementById('state');
  const btnFw = document.getElementById('fw');
  const btnBk = document.getElementById('back');

  const cfg = {
    zMin: -3800,
    zMax:  2300,
    blurMax: 10,
    visibilityZ: 2200,
    tiltMax: 3.5,
    scaleClampMin: .32,
    scaleClampMax: 2.0,

    /* douceur */
    SPEED: 0.9,
    TOUCH_SENS: 1.4,
    KEY_STEP: 160,
    BTN_STEP: 220,

    /* pause & stick */
    SNAP_WIN: 170,
    DWELL_MS: 1400,
    BREAK_FORCE: 520,
    STICK_MS: 900,
    STICK_FACTOR: 0.45,
    FADE_STICK_PX: 340,

    /* lat√©ral */
    SIDE_MAX: 380,     // px max d‚Äô√©cart lat√©ral en sortie
    SIDE_EASE: 0.85    // courbe (0..1) ‚Äî 1 = lin√©aire; <1 = ease-out
  };

  let targetZ = cfg.zMin, camZ = cfg.zMin, vZ = 0;
  let tiltX=0, tiltY=0, ttx=0, tty=0;

  let mode = 'free'; let dwellTimer = 0; let focusedIndex = -1;
  let stick = { active:false, index:-1, startCamZ:0, startTime:0 };

  function setMode(m){ mode=m; stateText.textContent='Mode: '+(m==='dwell'?'pause':'libre'); }
  function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }
  function updateHUD(){
    const p = (camZ - cfg.zMin) / (cfg.zMax - cfg.zMin);
    prog.style.width = (Math.max(0,Math.min(1,p))*100).toFixed(1)+'%';
    depthText.textContent = `Z: ${Math.round(camZ)}`;
  }
  function nearestLayerIndex(z){
    let best=-1, dmin=1e9;
    for(let i=0;i<layers.length;i++){ const z0=+layers[i].dataset.z||0, d=Math.abs(z0-z); if(d<dmin){dmin=d; best=i;} }
    return best;
  }
  function enterDwell(i){
    focusedIndex=i; const z0=+layers[i].dataset.z||0;
    targetZ=z0; vZ=0; dwellTimer=performance.now()+cfg.DWELL_MS; setMode('dwell');
    layers.forEach(L=>L.classList.remove('focused')); layers[i].classList.add('focused'); stick.active=false;
  }
  function beginStick(i){ stick={active:true,index:i,startCamZ:camZ,startTime:performance.now()}; }
  function exitDwell(startStick=true){
    const i=focusedIndex; setMode('free'); layers.forEach(L=>L.classList.remove('focused'));
    dwellTimer=0; focusedIndex=-1; if(startStick && i>=0) beginStick(i);
  }

  /* Lat√©ral: offset X en fonction de la profondeur relative */
  function sideOffset(depth, dir){
    // depth < 0 : avant le focus -> centr√© (0)
    // depth > 0 : apr√®s le focus -> glisse vers SIDE_MAX*dir (ease-out)
    if(depth <= 0) return 0;
    const t = clamp(depth / 900, 0, 1);                // distance post-focus normalis√©e
    const eased = 1 - Math.pow(1 - t, cfg.SIDE_EASE);  // ease-out
    return eased * cfg.SIDE_MAX * dir;
  }

  /* tilt pointeur */
  addEventListener('pointermove', e=>{
    const cx = innerWidth/2, cy = innerHeight/2;
    const nx = (e.clientX - cx)/cx, ny = (e.clientY - cy)/cy;
    tty = nx * cfg.tiltMax; ttx = -ny * cfg.tiltMax;
  }, {passive:true});

  /* wheel */
  addEventListener('wheel', e=>{
    const dy = e.deltaY, impulse = dy * cfg.SPEED;
    if(mode==='dwell'){ if(Math.abs(impulse) >= cfg.BREAK_FORCE){ exitDwell(true); vZ += impulse; } }
    else vZ += impulse;
    e.preventDefault();
  }, {passive:false});

  /* touch */
  let touching=false, lastY=0, lastT=0;
  viewport.addEventListener('touchstart', e=>{
    touching=true; vZ*=0.3; lastY=e.touches[0].clientY; lastT=performance.now();
  }, {passive:true});
  viewport.addEventListener('touchmove', e=>{
    if(!touching) return;
    const y=e.touches[0].clientY, dy=(lastY-y)*cfg.TOUCH_SENS;
    const now=performance.now(), dt=Math.max(16, now-lastT);
    const impulse=(dy*16/dt)*16;
    if(mode==='dwell'){ if(Math.abs(impulse)>=cfg.BREAK_FORCE){ exitDwell(true); vZ+=impulse; } }
    else vZ+=impulse;
    lastY=y; lastT=now; e.preventDefault();
  }, {passive:false});
  addEventListener('touchend', ()=>{ touching=false; }, {passive:true});

  /* boutons */
  let holdFw=false, holdBk=false;
  fw.addEventListener('pointerdown', ()=>{ if(mode==='dwell') exitDwell(true); holdFw=true; vZ -= cfg.BTN_STEP; });
  back.addEventListener('pointerdown', ()=>{ if(mode==='dwell') exitDwell(true); holdBk=true; vZ += cfg.BTN_STEP; });
  addEventListener('pointerup', ()=>{ holdFw=false; holdBk=false; });

  /* clavier */
  addEventListener('keydown', e=>{
    const k=e.key.toLowerCase();
    if(k==='arrowdown'||k==='pagedown'){ if(mode==='dwell') exitDwell(true); vZ -= cfg.KEY_STEP*2; }
    if(k==='arrowup'  ||k==='pageup'  ){ if(mode==='dwell') exitDwell(true); vZ += cfg.KEY_STEP*2; }
  });

  function maybeEnterDwell(){
    if(mode==='dwell') return;
    const i = nearestLayerIndex(camZ), z0=+layers[i].dataset.z||0, d=Math.abs(z0-camZ);
    if(d <= cfg.SNAP_WIN && Math.abs(vZ) < 60){ enterDwell(i); targetZ=z0; }
  }

  function render(){
    const now = performance.now();

    if(mode!=='dwell'){ if(holdFw) vZ -= 10; if(holdBk) vZ += 10; }

    if(mode==='dwell'){
      if(focusedIndex>=0){ const z0=+layers[focusedIndex].dataset.z||0; targetZ=z0; }
      vZ *= 0.78;
      if(now >= dwellTimer) exitDwell(true);
    } else {
      targetZ += vZ;
      vZ *= 0.82;
    }

    targetZ = clamp(targetZ, cfg.zMin, cfg.zMax);
    camZ += (targetZ - camZ)*0.1;

    /* tilt */
    const ex=0.1; tiltX += (ttx - tiltX)*ex; tiltY += (tty - tiltY)*ex;
    scene.style.transform = `rotateX(${tiltX}deg) rotateY(${tiltY}deg)`;

    maybeEnterDwell();

    /* rendu couches */
    for(let i=0;i<layers.length;i++){
      const L = layers[i];
      const z0 = +L.dataset.z||0;
      const dir = Math.sign(+L.dataset.dir|| (i%2?1:-1)) || 1;

      let depth = z0 - camZ;

      /* STICK: suit l√©g√®rement apr√®s la pause */
      if(stick.active && stick.index===i){
        const t = clamp((now - stick.startTime)/cfg.STICK_MS, 0, 1);
        const follow = (camZ - stick.startCamZ) * cfg.STICK_FACTOR * (1 - t);
        depth += follow;
        if(t>=1) stick.active=false;
      }

      /* lat√©ral apr√®s focus */
      const xSide = sideOffset(depth, dir);

      /* scale / opacity / blur */
      const scale = clamp( 1 / (1 + (depth/1100)), cfg.scaleClampMin, cfg.scaleClampMax );
      let distFade = Math.abs(depth);
      if(stick.active && stick.index===i){
        const t = clamp((now - stick.startTime)/cfg.STICK_MS, 0, 1);
        distFade = Math.max(0, distFade - (1 - t)*cfg.FADE_STICK_PX);
      }
      const o = clamp(1 - (distFade/cfg.visibilityZ), 0, 1);
      const blur = (1 - Math.max(0, 1 - distFade/900)) * cfg.blurMax;

      const yOffset = depth/46;

      L.style.transform =
        `translate(-50%,-50%) translateX(${xSide}px) translateZ(${depth}px) translateY(${yOffset}px) `+
        `scale(${scale}) rotateX(${tiltX*0.28}deg) rotateY(${tiltY*0.28}deg)`;
      L.style.setProperty('--o', o.toFixed(3));
      L.style.setProperty('--blur', blur.toFixed(2)+'px');
      if(o < 0.05) L.setAttribute('aria-hidden','true'); else L.removeAttribute('aria-hidden');
    }

    updateHUD();
    requestAnimationFrame(render);
  }
  render();
})();
</script>
</body>
</html>
