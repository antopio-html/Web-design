<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
<title>PRISM — Picker H + S×L (stable) & Palette</title>
<style>
  :root{
    --bg:#0b0f16; --ink:#f2f6ff; --muted:#9fb0d3; --ring:rgba(255,255,255,.16);
    --card:rgba(255,255,255,.06);
    /* palette appliquée (remplie via “Appliquer”) */
    --p1:#6c66fa; --p2:#cd66fa; --p3:#9d66fa; --p4:#668ffa; --p5:#fa66f4;
    --acc: var(--p3); --acc-2: var(--p5);
    --pad: clamp(14px, 5vw, 22px); --container: 1080px;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f7faff; --ink:#0e1116; --muted:#4e5a73; --ring:rgba(0,0,0,.14); --card:rgba(0,0,0,.06) }
  }

  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font: clamp(18px,4.6vw,20px)/1.6 Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; overflow-x:hidden}
  *{box-sizing:border-box}

  .container{max-width:var(--container); margin-inline:auto; padding-inline:var(--pad)}

  header{position:sticky; top:0; z-index:10; border-bottom:1px solid var(--ring);
    background: color-mix(in oklab, var(--card) 82%, transparent); backdrop-filter: blur(10px) saturate(140%)}
  .head-inner{display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding-block: max(10px, env(safe-area-inset-top)) 10px}
  .brand{font-weight:900; display:flex; align-items:center; gap:.6em}
  .dot{width:12px;height:12px;border-radius:50%;background:linear-gradient(180deg,var(--acc),var(--acc-2));box-shadow:0 0 14px var(--acc)}
  .btn{appearance:none; border:1px solid var(--ring); background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(255,255,255,.06));
    color:inherit; border-radius:16px; padding:12px 16px; font-weight:900; min-height:44px}
  .btn.primary{background:linear-gradient(180deg,color-mix(in oklab,var(--acc) 28%, transparent), transparent);
    box-shadow:0 8px 26px color-mix(in oklab,var(--acc) 24%, transparent)}

  main{padding-block: var(--pad)}
  .panel{background:var(--card); border:1px solid var(--ring); border-radius:18px;
    padding: clamp(12px,4.5vw,18px); display:grid; gap: clamp(10px,3.5vw,16px); margin-block: var(--pad)}
  h1{margin:0; font-weight:900; font-size: clamp(22px,6.6vw,32px)}
  h2{margin:0; font-weight:900; font-size: clamp(20px,6vw,26px)}
  .sub{color:var(--muted)}
  .actions{display:flex; flex-wrap:wrap; gap:8px; justify-content:center}

  /* === PICKER H + S×L === */
  .picker{display:grid; gap:14px; justify-items:center}
  .hue-wrap{width:100%; max-width:680px; position:relative}
  .hue{width:100%; height:28px; border-radius:999px; border:1px solid var(--ring); background:linear-gradient(90deg, red, yellow, lime, cyan, blue, magenta, red)}
  .h-handle{position:absolute; top:50%; transform:translate(-50%,-50%);
    width:26px;height:26px;border-radius:50%; background:#fff; border:2px solid #111; box-shadow:0 0 0 6px rgba(0,0,0,.18); pointer-events:none}

  .sl-wrap{width:100%; max-width:680px; aspect-ratio: 7/4; position:relative; border:1px solid var(--ring); border-radius:16px; overflow:hidden}
  .sl{width:100%; height:100%; display:block}
  .sl-top{position:absolute; inset:0; background:
    linear-gradient(90deg, #fff, rgba(255,255,255,0)),
    linear-gradient(0deg, #000, rgba(0,0,0,0));
    mix-blend-mode:normal; pointer-events:none}
  .sl-handle{position:absolute; width:22px;height:22px; border-radius:50%; background:#fff; border:2px solid #111; transform:translate(-50%,-50%); box-shadow:0 0 0 6px rgba(0,0,0,.18); pointer-events:none}

  /* === Palette (5 colonnes) === */
  .bar{ background:var(--card); border:1px solid var(--ring); border-radius:18px; padding: clamp(8px,3vw,12px) }
  .bar-grid{ display:grid; grid-template-columns: repeat(5, 1fr); gap: clamp(6px,2vw,10px) }
  .slot{ border:1px solid var(--ring); border-radius:14px; overflow:hidden; display:grid; grid-template-rows: 100px auto }
  @media (max-width: 380px){ .slot{ grid-template-rows: 88px auto } }
  .swatch{ width:100%; height:100% }
  .hex{ padding:8px; text-align:center; font-weight:900; letter-spacing:.3px; font-family: ui-monospace, Menlo, Consolas, monospace; position:relative }
  .baseMark{ position:absolute; left:50%; top:-6px; transform:translateX(-50%); font-size:16px }

  /* Aperçu & export */
  .preview{display:grid; gap:10px}
  .pane{border:1px solid var(--ring); border-radius:16px; overflow:hidden}
  .pane header{display:flex; justify-content:space-between; gap:10px; padding:10px 12px; color:var(--muted); border-bottom:1px solid var(--ring); background:color-mix(in oklab,var(--card) 72%, transparent)}
  .pane .box{min-height:86px; padding:12px; font-weight:900; font-size: clamp(18px,5.2vw,22px)}
  textarea.tokens{width:100%; min-height:140px; font:15px/1.5 ui-monospace,Menlo,Consolas,monospace; color:var(--ink); background:transparent; border:1px dashed var(--ring); border-radius:14px; padding:12px}

  /* Thème “hard” : applique le set au site */
  .themed-hard *{ accent-color: var(--acc) !important; }
  .themed-hard a, .themed-hard a:visited{ color: var(--p3) !important; }
  .themed-hard button, .themed-hard .btn{
    background: linear-gradient(180deg, color-mix(in oklab, var(--p3) 30%, transparent), transparent) !important;
    border-color: color-mix(in oklab, var(--p3) 45%, var(--ring)) !important; color: var(--ink) !important;
  }
  .themed-hard input, .themed-hard select, .themed-hard textarea{
    border-color: color-mix(in oklab, var(--p4) 40%, var(--ring)) !important;
    background: color-mix(in oklab, var(--card) 75%, transparent) !important; color: var(--ink) !important;
  }
  .themed-hard ::selection{ background: color-mix(in oklab, var(--p2) 55%, transparent); color:#000 }
  .themed-hard .panel, .themed-hard .bar, .themed-hard .pane, .themed-hard textarea.tokens{
    border-color: color-mix(in oklab, var(--p4) 38%, var(--ring)) !important;
    box-shadow: 0 0 0 1px color-mix(in oklab, var(--p1) 22%, transparent) inset !important;
  }
  .themed-hard h1, .themed-hard h2, .themed-hard h3{
    color: var(--ink) !important; text-shadow: 0 0 18px color-mix(in oklab, var(--p5) 35%, transparent)
  }
</style>
</head>
<body>
  <header>
    <div class="container head-inner">
      <div class="brand"><span class="dot"></span> PRISM — Générateur</div>
      <div class="actions">
        <button class="btn" id="random">Aléatoire</button>
        <button class="btn primary" id="apply">Appliquer au site</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- PICKER -->
    <section class="panel">
      <h1>Couleur principale</h1>
      <p class="sub">Ajuste la teinte (H) puis précise saturation (S) & luminosité (L) dans le carré.</p>
      <div class="picker">
        <!-- Hue -->
        <div class="hue-wrap" id="hueWrap" aria-label="Teinte">
          <div class="hue" id="hueBar"></div>
          <div class="h-handle" id="hHandle" style="left:50%"></div>
        </div>
        <!-- Saturation × Luminosité -->
        <div class="sl-wrap" id="slWrap" aria-label="Saturation et Luminosité">
          <canvas id="sl"></canvas>
          <div class="sl-top"></div>
          <div class="sl-handle" id="slHandle" style="left:80%; top:45%"></div>
        </div>
      </div>
    </section>

    <!-- Harmonies (modes) -->
    <section class="panel">
      <div class="actions" id="modes">
        <button class="btn chip" data-mode="analog">Analogues</button>
        <button class="btn chip" data-mode="complement">Complémentaire</button>
        <button class="btn chip" data-mode="triad">Triade</button>
        <button class="btn chip" data-mode="tetrad">Tétrade</button>
        <button class="btn chip" data-mode="mono">Monochrome</button>
      </div>
    </section>

    <!-- Palette 5 colonnes -->
    <section class="bar">
      <div class="bar-grid" id="barGrid"></div>
    </section>

    <!-- Aperçu & export -->
    <section class="panel">
      <h2>Contraste & export</h2>
      <div class="preview">
        <div class="pane">
          <header><span>Fond clair</span><span id="wcagLight">—</span></header>
          <div class="box" id="demoLight" style="background:#ffffff; color:#111">Aa — Titre & Bouton</div>
        </div>
        <div class="pane">
          <header><span>Fond sombre</span><span id="wcagDark">—</span></header>
          <div class="box" id="demoDark" style="background:#0b0f16; color:#f2f6ff">Aa — Titre & Bouton</div>
        </div>
      </div>
      <textarea class="tokens" id="tokens" readonly></textarea>
      <div class="actions">
        <button class="btn" id="copyCss">Copier CSS</button>
        <button class="btn" id="copyJson">Copier JSON</button>
      </div>
    </section>
  </main>

<script>
/* ===== Helpers ===== */
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const rgbToHex=(r,g,b)=>'#'+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');
const hslToRgb=(h,s,l)=>{ s/=100; l/=100; const k=n=>(n+(h/30))%12; const a=s*Math.min(l,1-l);
  const f=n=> l - a*Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1)));
  return [Math.round(255*f(0)),Math.round(255*f(8)),Math.round(255*f(4))] };
const hslToHex=(h,s,l)=>rgbToHex(...hslToRgb(h,s,l));
const hexToRgb=(hex)=>{ const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return m?[parseInt(m[1],16),parseInt(m[2],16),parseInt(m[3],16)]:[0,0,0] };
const luminance=(r,g,b)=>{ const t=[r,g,b].map(v=>{v/=255; return v<=.03928?v/12.92:Math.pow((v+0.055)/1.055,2.4)}); return 0.2126*t[0]+0.7152*t[1]+0.0722*t[2] };
const contrastRatio=(hex1,hex2)=>{ const [r1,g1,b1]=hexToRgb(hex1),[r2,g2,b2]=hexToRgb(hex2); const L1=luminance(r1,g1,b1)+0.05, L2=luminance(r2,g2,b2)+0.05; return Math.round((L1>L2?L1/L2:L2/L1)*100)/100 };
const wcag=r=> r>=7?'AAA': r>=4.5?'AA': r>=3?'AA (large)':'fail';
const rot=(h,d)=>(((h+d)%360)+360)%360;

/* ===== DOM ===== */
const hueWrap = document.getElementById('hueWrap');
const hueBar  = document.getElementById('hueBar');
const hHandle = document.getElementById('hHandle');

const slWrap  = document.getElementById('slWrap');
const slCanvas= document.getElementById('sl');
const slHandle= document.getElementById('slHandle');

const modes   = document.getElementById('modes');
const barGrid = document.getElementById('barGrid');

const demoL   = document.getElementById('demoLight');
const demoD   = document.getElementById('demoDark');
const wcagL   = document.getElementById('wcagLight');
const wcagD   = document.getElementById('wcagDark');
const tokens  = document.getElementById('tokens');

const randomBtn = document.getElementById('random');
const applyBtn  = document.getElementById('apply');
const copyCss   = document.getElementById('copyCss');
const copyJson  = document.getElementById('copyJson');

/* ===== State ===== */
let H=264, S=80, L=60; // base
let MODE='analog';
let dpr = Math.min(window.devicePixelRatio||1, 2);

/* ===== SL canvas draw ===== */
function drawSL(){
  const w = Math.floor(slWrap.clientWidth * dpr);
  const h = Math.floor(slWrap.clientHeight * dpr);
  if(w<=0 || h<=0) return;
  slCanvas.width=w; slCanvas.height=h;
  const ctx = slCanvas.getContext('2d', { willReadFrequently:false });

  // base hue background (pure color @ 50% lightness)
  const base = hslToHex(H, 100, 50);
  ctx.fillStyle = base; ctx.fillRect(0,0,w,h);

  // white gradient (left -> right saturation)
  const gradS = ctx.createLinearGradient(0,0,w,0);
  gradS.addColorStop(0, '#ffffff'); gradS.addColorStop(1, 'rgba(255,255,255,0)');
  ctx.fillStyle = gradS; ctx.fillRect(0,0,w,h);

  // black gradient (bottom -> top lightness)
  const gradL = ctx.createLinearGradient(0,0,0,h);
  gradL.addColorStop(0, 'rgba(0,0,0,1)'); gradL.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle = gradL; ctx.fillRect(0,0,w,h);

  // position handle
  slHandle.style.left = (S)+'%';
  slHandle.style.top  = (100-L)+'%';
}

/* ===== Build palette (5, base au centre) ===== */
function buildSet5(){
  if(MODE==='mono') return [[H,S,clamp(L-24,0,100)],[H,S,clamp(L-12,0,100)],[H,S,L],[H,S,clamp(L+12,0,100)],[H,S,clamp(L+24,0,100)]];
  const off = MODE==='analog'     ? [-30,-15,0,15,30]
            : MODE==='complement' ? [-180,-30,0,30,180]
            : MODE==='triad'      ? [-120,-30,0,30,120]
            : /* tetrad */          [-90,0,90,180,-45];
  return off.map(d=>[rot(H,d), S, L]);
}

/* ===== Render UI ===== */
function render(){
  // hue handle position
  const rect = hueWrap.getBoundingClientRect();
  const x = rect.width * (H/360);
  hHandle.style.left = `${clamp(x, 0, rect.width)}px`;

  // draw SL and palette
  drawSL();

  // palette bar
  const set = buildSet5();
  barGrid.innerHTML='';
  set.forEach(([h,s,l],i)=>{
    const hex=hslToHex(h,s,l);
    const el=document.createElement('div');
    el.className='slot';
    el.innerHTML=`<div class="swatch" style="background:${hex}"></div>
      <div class="hex">${i===2?'<span class="baseMark">▲</span>':''}${hex.toUpperCase()}</div>`;
    barGrid.appendChild(el);
  });

  // preview + export
  const baseHex = hslToHex(H,S,L);
  demoL.style.color=baseHex; demoD.style.color=baseHex;
  const cL=contrastRatio(baseHex,'#ffffff'), cD=contrastRatio(baseHex,'#0b0f16');
  wcagL.textContent=`Contraste: ${cL} (${wcag(cL)})`;
  wcagD.textContent=`Contraste: ${cD} (${wcag(cD)})`;

  const [c1,c2,c3,c4,c5] = set.map(([h,s,l])=>hslToHex(h,s,l));
  tokens.value = `:root{
  --p1: ${c1};
  --p2: ${c2};
  --p3: ${c3}; /* base */
  --p4: ${c4};
  --p5: ${c5};
  --acc: var(--p3);
  --acc-2: var(--p5);
}`;
}

/* ===== Interactions : robustes et simples ===== */
function onHueAt(clientX){
  const r = hueWrap.getBoundingClientRect();
  const t = clamp((clientX - r.left)/r.width, 0, 1);
  H = Math.round(t*360) % 360;
  render();
}
function onSLAt(clientX, clientY){
  const r = slWrap.getBoundingClientRect();
  const tx = clamp((clientX - r.left)/r.width, 0, 1);
  const ty = clamp((clientY - r.top )/r.height, 0, 1);
  S = Math.round(tx*100);
  L = Math.round((1-ty)*100);
  render();
}

function addDrag(el, start, move){
  let dragging=false;
  const getXY = (e)=> ({
    x: e.clientX ?? (e.touches && e.touches[0] && e.touches[0].clientX),
    y: e.clientY ?? (e.touches && e.touches[0] && e.touches[0].clientY),
  });
  const onStart=(e)=>{ e.preventDefault(); dragging=true; const {x,y}=getXY(e); start(x,y); };
  const onMove =(e)=>{ if(!dragging) return; e.preventDefault(); const {x,y}=getXY(e); move(x,y); };
  const onEnd  =()=>{ dragging=false };
  ['pointerdown','mousedown','touchstart'].forEach(ev=> el.addEventListener(ev,onStart,{passive:false}));
  ['pointermove','mousemove','touchmove'].forEach(ev=> window.addEventListener(ev,onMove,{passive:false}));
  ['pointerup','mouseleave','touchend','touchcancel'].forEach(ev=> window.addEventListener(ev,onEnd));
}

addDrag(hueWrap, (x)=>onHueAt(x), (x)=>onHueAt(x));
addDrag(slWrap , (x,y)=>onSLAt(x,y), (x,y)=>onSLAt(x,y));

/* Modes */
modes.querySelectorAll('.chip').forEach(b=>{
  if(b.dataset.mode===MODE) b.classList.add('active');
  b.addEventListener('click', ()=>{
    modes.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
    b.classList.add('active'); MODE=b.dataset.mode; render();
  });
});

/* Random presets */
const curated=[ ['Vaporwave',[315,80,65],'triad'], ['Tropical',[170,75,50],'analog'],
  ['Arcade',[200,90,55],'tetrad'], ['Sunset',[18,85,58],'complement'],
  ['Aurora',[155,70,54],'analog'], ['Sakura',[340,70,66],'mono'], ['Cyber',[190,90,55],'tetrad'] ];
randomBtn?.addEventListener('click', ()=>{
  const pick = curated[Math.floor(Math.random()*curated.length)];
  const [_,[h,s,l],m]=pick; H=h;S=s;L=l;MODE=m;
  render();
});

/* Appliquer : pousse TOUTES les couleurs */
applyBtn.addEventListener('click', ()=>{
  const set = buildSet5().map(([h,s,l])=>hslToHex(h,s,l));
  const root=document.documentElement.style;
  root.setProperty('--p1', set[0]);
  root.setProperty('--p2', set[1]);
  root.setProperty('--p3', set[2]); // base
  root.setProperty('--p4', set[3]);
  root.setProperty('--p5', set[4]);
  root.setProperty('--acc', 'var(--p3)');
  root.setProperty('--acc-2', 'var(--p5)');
  document.documentElement.classList.add('themed-hard');
  document.querySelector('.dot').style.background = `linear-gradient(180deg, ${set[2]}, ${set[4]})`;
});

/* Copies */
copyCss.onclick=()=> navigator.clipboard.writeText(tokens.value);
copyJson.onclick=()=>{
  const set = buildSet5().map(([h,s,l])=>hslToHex(h,s,l));
  const obj = { p1:set[0], p2:set[1], p3:set[2], p4:set[3], p5:set[4], acc:set[2], acc2:set[4] };
  navigator.clipboard.writeText(JSON.stringify(obj,null,2));
};

/* Init & Resize */
function onResize(){ dpr=Math.min(window.devicePixelRatio||1,2); drawSL(); render(); }
window.addEventListener('resize', onResize, {passive:true});
onResize();
</script>
</body>
</html>
